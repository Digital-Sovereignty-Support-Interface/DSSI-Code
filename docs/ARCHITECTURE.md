# 🏛️ DSSI System Architecture: 構造と役割の解説

本ドキュメントでは、DSSI（Digital Sovereignty Support Interface）が技術的にどのように構成され、各ファイルがどのような役割を担っているかを解説します。

専門的な知識（JavaやWeb標準）がない方でも、DSSIが「どこで」「何を」しているかを理解できるように、建物の構造に例えて記述しています。

---

## 🏛️ 第一部：全体構造と司令室（制御系）

拡張機能は、バラバラのファイルが勝手に動いているのではなく、`manifest.json` という「名簿兼指示書」によって統制されています。

### 1. `manifest.json` （全体設計図・名簿）
**役割:** ブラウザ（Chrome/Edge）に対する「自己紹介カード」です。「私は誰で、どんな権限を持ち、どのファイルがどの役割をするか」を宣言します。

* **`"permissions": ["activeTab", "storage"]`**
    * **解説:** 「今開いているタブの中身を見る権限」と、「設定（ON/OFFなど）をブラウザに記憶させる権限」を要求しています。これがDSSIの活動許可証です。
* **`"action": { "default_popup": "popup.html" }`**
    * **解説:** 「ツールバーのアイコンがクリックされたら、`popup.html` という小さな窓を表示せよ」という指示です。これが**「司令室」**への入り口です。
* **`"background": { "service_worker": "background.js" }`**
    * **解説:** 「画面には出ないけれど、裏でずっと待機している**『参謀（脳）』**として `background.js` を雇え」という指示です。
* **`"content_scripts": [ ... "js": ["content.js"], "css": ["styles.css"] ... ]`**
    * **解説:** 「ユーザーがWebページを開くたびに、そのページの中に**『現場監督（目と手）』**として `content.js` と `styles.css` を送り込め」という指示です。これがDSSIの主力部隊です。

### 2. `popup.html` & `popup.js` （司令室・リモコン）
**場所:** アイコンをクリックした時に出る小さなウィンドウ。
**役割:** ユーザーの意志（ON/OFF、リセット）を受け付け、現場に指令を飛ばす場所です。Webページそのものとは隔離された空間にいます。

* **`popup.html` (見た目):**
    * スイッチやリセットボタンの配置（骨格）を作っています。
* **`popup.js` (動き):**
    * **記憶の読み書き (`chrome.storage`):** ウィンドウが開いた瞬間、ブラウザの記憶領域から「今はONか？OFFか？」を読み出し、スイッチの状態を合わせます。スイッチが切り替えられたら、その結果を記憶領域に保存します（永続化）。
    * **指令の伝達 (`sendMessage`):** スイッチが動いた瞬間、「今見ているタブ（現場）」に向かって、「おい！設定が変わったぞ（`TOGGLE_GUARD`）」や「リセットだ（`RESET_GUARD`）」というメッセージ（電波）を飛ばします。

### 3. `background.js` （参謀・データベース）
**場所:** ブラウザの裏側（ユーザーには見えない）。
**役割:** 現場（`content.js`）では処理しきれない高度な判断や、データ照合を行う**「知能」**です。

* **メッセージの待受 (`onMessage`):**
    * 現場から「このURL（https://...）の証明書はどうなってる？」という問い合わせが飛んでくるのを待ち受けます。
* **模擬判定ロジック:**
    * 本来はここで外部の認証局などに問い合わせを行いますが、現在はMVP（試作）のため、`expired.badssl.com` というURLが来たら「期限切れだよ」と返す、という**「台本通りの演技（Mock）」**を行っています。
    * *Future:* Phase 2以降、ここが本当のAI（Gemini API）と接続する「通信基地」に進化します。

---

## 🏛️ 第二部：現場部隊の解剖図

### 4. `content.js` （現場監督：目と手）
このファイルは、ウェブページの中に常駐し、**「監視（Observer）」**と**「介入（Intervention）」**を行う、DSSIの主力エンジンです。大きく分けて **5つのモジュール（機能の塊）** で構成されています。

#### (1) 監視の網 (Target Definition)
* **役割:** 「何を探すか」を定義します。
* **ロジック:** `TARGET_SELECTORS` という定数に、「パスワード欄」「メール欄」「カード番号欄」の特徴（タグの名前など）をリストアップしています。これを使い、ページ内から該当する要素を一網打尽にします。

#### (2) 記憶と判断 (Storage Logic)
* **役割:** 「このチップスはもう見たくない（ミュート）」というユーザーの意思を確認します。
* **ロジック:** `getChipStats` でブラウザの記憶領域（Storage）を見て、「ミュートフラグ」が立っているか確認します。もしミュートなら、チップスを表示する処理をスキップします。ただし、「1分（本番は30日）経ったら忘れる」という**「期限切れチェック」**もここで行っています。

#### (3) 鑑定と分類 (Field Configuration)
* **役割:** 見つけた入力欄が「何用」なのかを鑑定し、適切なメッセージを選びます。
* **ロジック:** `getFieldConfig` 関数が、「`type="password"`ならオレンジ色」「`name="card"`なら赤色」といったルールブックに従って、表示データ（色、文言）を決定します。

#### (4) 物理的介入 (Rendering & Guard)
* **役割:** 画面に「枠線」と「チップス」を描画し、危険な送信を止めます。
* **ロジック:**
    * `renderChip`: HTMLの `<div>` 要素をプログラムで生成し、画面に追加します。これがチップスの実体です。
    * `attachSubmitGuard`: ページ内の「送信イベント（submit）」を監視し、もしHTTP通信なら `preventDefault()` という命令で**送信を握りつぶし（キャンセルし）**、代わりに警告チップスを出します。

#### (5) 起動制御 (Control Center)
* **役割:** 司令室（Popup）からの命令で、自分自身を起動したり停止したりします。
* **ロジック:** `startGuard` で監視ループ（2秒ごとのスキャン）を回し、`stopGuard` で画面上のチップスや枠線をすべて削除して「撤収」します。

### 5. `styles.css` （衣装と演出）
`content.js` が役者なら、`styles.css` はその「衣装」と「演出」です。JavaScriptで操作するための **「状態（クラス名）」** を定義しています。

* **`.dssi-observed-field` （枠線）:** 検知された入力欄に付与されるクラスです。色（赤・青・オレンジ）はJS側で指定しますが、線の太さや影（光るエフェクト）はここで定義しています。
* **`.dssi-danger-field` （危険信号）:** HTTP通信などの危険な状態の時、枠線を **「赤く点滅（パルスアニメーション）」** させるための特殊効果です。
* **`.dssi-chip` （チップス本体）:** チップスの見た目（黒い背景、丸い角）だけでなく、**「普段はクリックを邪魔しない（`pointer-events: none`）」** という重要な設定を持っています。
* **`.dssi-visible` （出現アニメーション）:** チップスが「ふわっ」と現れるアニメーションを定義しています。JSがこのクラスを付け外しすることで、表示・非表示を切り替えています。

---

## ⚙️ 全体の連動イメージ（まとめ）

1.  あなたがページを開く。
2.  **`content.js`** が潜入し、入力欄を探す。
3.  見つけたら、**`background.js`** に「このページの証明書は大丈夫？」と電話する。
4.  大丈夫なら、**`styles.css`** の「枠線」を着せて、入力欄を目立たせる。
5.  あなたがマウスを乗せると、**`content.js`** が「チップス」を生成して表示する。
6.  もしあなたが「送信」を押して、かつ危険な状態なら、**`content.js`** が腕を掴んで止め、「本当にいいの？」と聞く。

これがDSSIの全貌です。「目（Content）」「脳（Background）」「司令室（Popup）」が連携して、ユーザーの主権を守る有機的なシステムになっています。